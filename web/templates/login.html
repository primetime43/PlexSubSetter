{% extends "base.html" %}
{% block title_suffix %} - Sign In{% endblock %}

{% block body %}
<div class="min-h-screen flex items-center justify-center" x-data="loginPage()">
    <div class="w-full max-w-md mx-auto text-center px-8">
        <!-- Title -->
        <h1 class="text-4xl font-bold mb-2">PlexSubSetter</h1>
        <p class="text-gray-400 mb-12">Mass Subtitle Manager for Plex</p>

        <!-- Login card -->
        <div class="space-y-6">
            <div class="text-5xl mb-6">&#127916;</div>

            <!-- Sign in button -->
            <button
                @click="startOAuth()"
                :disabled="loading"
                class="w-full py-4 px-6 rounded-lg font-bold text-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                :class="loading ? 'bg-plex-gold/70 text-gray-900' : 'bg-plex-gold hover:bg-plex-gold-hover text-gray-900'"
            >
                <span x-text="buttonText">Sign in with Plex</span>
            </button>

            <!-- Status -->
            <div x-show="status" x-cloak>
                <p :class="statusClass" class="text-sm mt-4" x-text="status"></p>
            </div>

            <!-- Info -->
            <p class="text-gray-500 text-xs mt-8 leading-relaxed">
                You'll be redirected to Plex.tv to sign in securely.<br>
                No credentials are stored in this application.
            </p>
        </div>

        <!-- Footer -->
        <div class="mt-16 text-gray-500 text-xs space-y-1">
            <p>Version {{ version }}</p>
            <p>Created by {{ author }}</p>
            <a href="{{ repo }}" target="_blank" class="text-blue-400 hover:underline">View on GitHub</a>
        </div>
    </div>
</div>

<script>
function loginPage() {
    return {
        loading: false,
        status: '',
        statusClass: 'text-plex-gold',
        buttonText: 'Sign in with Plex',
        pollInterval: null,

        async startOAuth() {
            this.loading = true;
            this.buttonText = 'Opening browser...';
            this.status = 'Opening your browser for authentication...';
            this.statusClass = 'text-yellow-400';

            try {
                const resp = await fetch('/auth/start-oauth', { method: 'POST' });
                const data = await resp.json();

                if (data.error) {
                    this.showError(data.error);
                    return;
                }

                // Open OAuth URL in new tab
                window.open(data.oauth_url, '_blank');

                this.status = 'Browser opened! Please sign in to Plex...\nWaiting for authentication...';
                this.statusClass = 'text-plex-gold';
                this.buttonText = 'Waiting for sign in...';

                // Start polling
                this.pollInterval = setInterval(() => this.pollOAuth(), 2000);
            } catch (e) {
                this.showError('Failed to start authentication: ' + e.message);
            }
        },

        async pollOAuth() {
            try {
                const resp = await fetch('/auth/poll-oauth');
                const data = await resp.json();

                if (data.status === 'authenticated') {
                    clearInterval(this.pollInterval);
                    this.status = 'Authenticated as ' + data.username + '! Redirecting...';
                    this.statusClass = 'text-green-400';
                    window.location.href = '/servers';
                } else if (data.status === 'error') {
                    clearInterval(this.pollInterval);
                    this.showError(data.error || 'Authentication failed');
                }
                // 'pending' - keep polling
            } catch (e) {
                // Network error during poll - keep trying
            }
        },

        showError(msg) {
            this.loading = false;
            this.buttonText = 'Sign in with Plex';
            this.status = msg;
            this.statusClass = 'text-red-400';
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
            }
        }
    }
}
</script>
{% endblock %}
